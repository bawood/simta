# @configure_input@

DESTDIR=@prefix@
MANDIR=@prefix@/man
BINDIR=@bindir@
ETCDIR=@sysconfdir@
SBINDIR=@sbindir@
RUNDIR=/var/run
RUNFILE=/var/run/simta.pid
LIBDIR=/usr/lib
SPOOLDIR=/var/spool/simta/
LOCAL_Q=/var/spool/simta/local
SLOW_Q=/var/spool/simta/slow
FAST_Q=/var/spool/simta/fast
DEAD_Q=/var/spool/simta/dead

SRC=    daemon.c receive.c argcargv.c envelope.c auth.c base64.c \
	simsend.c rfc822.c rcptlist.c tz.c tlsconnect.c address.c \
	createdb.c ldap.c
SIMTAOBJ=	daemon.o receive.o argcargv.o envelope.o base64.o tz.o \
		address.o line_file.o ll.o bdb.o header.o simta.o queue.c \
		ml.o smtp.o expand.o mx.o bounce.o nlist.o q_cleanup.o \
		ldap.o
TLSCONOBJ=	tlsconnect.o
SIMSENDOBJ=	simsend.o line_file.o envelope.o tz.o header.o simta.o \
		ll.o nlist.o
SIMLOGOBJ=	simlog.o
QRUNNEROBJ=	q_runner.c queue.o ll.o line_file.o envelope.o tz.o ml.o \
		simta.o smtp.o expand.o address.o bdb.o header.o bounce.o \
		nlist.o q_cleanup.o ldap.o
QCLEANUPOBJ=	q_cleanup.c queue.o ll.o line_file.o envelope.o tz.o ml.o \
		smtp.o simta.o
CREATEDBOBJ=	createdb.o argcargv.o bdb.o

SIMTALOG=LOG_MAIL
SIMTA_ALIAS_DB=	@aliasdb@
SIMTA_MAXCONNECTIONS=	@maxconnections@
RESOLV_CONF=	@resolvconf@

CC=		@CC@
OPTOPTS=	@OPTOPTS@
INSTALL=	@INSTALL@
INCPATH=	-Idenser -Ilibsnet @CPPFLAGS@
DEFS=		-DLOG_SIMTA=${SIMTALOG} -DTLS
LIBPATH=	-Ldenser -Llibsnet/.libs @LDFLAGS@
LIBS=		-ldnsr -lsnet -lldap @LIBS@
TAGSFILE=	tags
CFLAGS=		${DEFS} ${OPTOPTS} ${INCPATH}

SIMTALIBPATH=	${LIBPATH} @SIMTALDFLAGS@
SIMTALIBS=	${LIBS} @SIMTALIBS@
SIMTAINCPATH=	@SIMTACPPFLAGS@ ${INCPATH} 
SIMTACFLAGS=	${DEFS} ${OPTOPTS} ${SIMTAINCPATH}

MAN1TARGETS=	simsendmail.1
TARGETS=	simta tlsconnect simsendmail q_runner createdb

all : ${TARGETS}

install : all FRC
	-mkdir -p ${RUNDIR}
	-touch ${RUNFILE}
	-chown -R simta ${RUNFILE}
	-chgrp -R simta ${RUNFILE}
	-chmod 755 ${RUNFILE}
	-mkdir -p ${MANDIR}/man1
	-mkdir -p ${LOCAL_Q}
	-mkdir -p ${SLOW_Q}
	-mkdir -p ${FAST_Q}
	-mkdir -p ${DEAD_Q}
	-chown -R simta ${SPOOLDIR}
	-chgrp -R simta ${SPOOLDIR}
	-chmod -R 700 ${SPOOLDIR}
	${INSTALL} -m 755 -o simta -g simta -c simta ${SBINDIR}/
	${INSTALL} -m 6755 -o simta -g simta -c simsendmail ${LIBDIR}/
	ln -f ${LIBDIR}/simsendmail ${LIBDIR}/sendmail
	for i in ${MAN1TARGETS}; do \
	    ${INSTALL} -m 0644 -c $$i ${MANDIR}/man1/; \
	done

simta : libsnet/libsnet.a denser/denser.o ${SIMTAOBJ} Makefile
	${CC} ${SIMTACFLAGS} ${LDFLAGS} -o simta ${SIMTAOBJ} ${SIMTALIBPATH} ${SIMTALIBS}

simsendmail : libsnet/libsnet.a denser/denser.o ${SIMSENDOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simsendmail ${SIMSENDOBJ} ${LIBPATH} \
	${LIBS}

createdb : ${CREATEDBOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o createdb ${CREATEDBOBJ} ${SIMTALIBPATH} \
	${SIMTALIBS}

createdb.o : createdb.c
	${CC} ${SIMTACFLAGS} \
	    -c createdb.c -o createdb.o

daemon.o : daemon.c
	${CC} ${CFLAGS} \
	    -DVERSION=\"`cat VERSION`\" \
	    -DSIMTA_MAXCONNECTIONS=${SIMTA_MAXCONNECTIONS} \
	    -c daemon.c -o daemon.o

receive.o : receive.c
	${CC} ${CFLAGS} \
		-DVERSION=\"`cat VERSION`\" \
		-c receive.c -o receive.o

simta.o : simta.c
	${CC} ${CFLAGS} \
		-DSIMTA_RESOLV_CONF=\"${RESOLV_CONF}\" \
		-c simta.c -o simta.o

bdb.o : bdb.c
	${CC} ${SIMTACFLAGS} \
		-c bdb.c -o bdb.o

address.o : address.c
	${CC} ${SIMTACFLAGS} \
		-DSIMTA_ALIAS_DB=\"${SIMTA_ALIAS_DB}\" \
		-c address.c -o address.o

tz.o : tz.c
	${CC} ${CFLAGS} @HAVE_TM_GMTOFF@ -c tz.c -o tz.o

tlsconnect : libsnet/libsnet.a denser/denser.o ${TLSCONOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o tlsconnect ${TLSCONOBJ} ${LIBPATH} ${LIBS}

simlog : libsnet/libsnet.a denser/denser.o ${SIMLOGOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o simlog ${SIMLOGOBJ} ${LIBPATH} ${LIBS}

ml.o : ml.c
	${CC} ${CFLAGS} \
		-DSIMTA_MAIL_LOCAL=\"@SIMTA_MAIL_LOCAL@\" \
		-DSIMTA_PROCMAIL=\"@SIMTA_PROCMAIL@\" \
		-c ml.c -o ml.o

q_runner : libsnet/libsnet.a denser/denser.o ${QRUNNEROBJ} Makefile
	${CC} ${SIMTACFLAGS} ${LDFLAGS} -o q_runner ${QRUNNEROBJ} ${SIMTALIBPATH} ${SIMTALIBS}

q_cleanup : libsnet/libsnet.a denser/denser.o ${QCLEANUPOBJ} Makefile
	${CC} ${CFLAGS} ${LDFLAGS} -o q_cleanup ${QCLEANUPOBJ} ${LIBPATH} ${LIBS}

FRC :

libsnet/libsnet.a : FRC
	cd libsnet; ${MAKE} ${MFLAGS} CC=${CC} DEFS="${DEFS}" \
		INCPATH="${INCPATH}"

denser/denser.o	: FRC
	cd denser; ${MAKE} ${MFLAGS} CC=${CC} INCPATH="${INCPATH}"

VERSION=`date +%Y%m%d`
DISTDIR=../simta-${VERSION}

dist : clean
	mkdir ${DISTDIR}
	tar chfFFX - EXCLUDE . | ( cd ${DISTDIR}; tar xvf - )
	chmod +w ${DISTDIR}/Makefile
	echo ${VERSION} > ${DISTDIR}/VERSION

clean :
	cd denser; ${MAKE} ${MFLAGS} clean
	cd libsnet; ${MAKE} ${MFLAGS} clean
	rm -f a.out core* *.o *.bak *[Ee]rrs tags
	rm -f ${TARGETS}
	rm -f simlog

realclean : clean
	rm -rf autom4te.cache
	rm -f config.status config.log
	rm -f Makefile
	cd libsnet; ${MAKE} ${MFLAGS} distclean
	cd denser; ${MAKE} ${MFLAGS} realclean

tags : ${SRC}
	cwd=`pwd`; \
	for i in ${SRC}; do \
	    ctags -t -a -f ${TAGSFILE} $$cwd/$$i; \
	done

depend :
	for i in ${SRC} ; do \
	    ${CC} -M ${DEFS} ${INCPATH} $$i | \
	    awk ' { if ($$1 != prev) { print rec; rec = $$0; prev = $$1; } \
		else { if (length(rec $$2) > 78) { print rec; rec = $$0; } \
		else rec = rec " " $$2 } } \
		END { print rec } ' >> makedep; done
	sed -n '1,/^# DO NOT DELETE THIS LINE/p' Makefile > Makefile.tmp
	cat makedep >> Makefile.tmp
	rm makedep
	echo '# DEPENDENCIES MUST END AT END OF FILE' >> Makefile.tmp
	echo '# IF YOU PUT STUFF HERE IT WILL GO AWAY' >> Makefile.tmp
	echo '# see make depend above' >> Makefile.tmp
	rm -f Makefile.bak
	cp Makefile Makefile.bak
	mv Makefile.tmp Makefile

# DO NOT DELETE THIS LINE
